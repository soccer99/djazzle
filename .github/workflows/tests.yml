name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
        django-version: ["4.2", "5.0", "5.1", "5.2"]
        db-backend: ["sqlite", "postgres", "mysql"]
        exclude:
          # Django 5.0+ requires Python 3.10+
          - python-version: "3.9"
            django-version: "5.0"
          - python-version: "3.9"
            django-version: "5.1"
          - python-version: "3.9"
            django-version: "5.2"
          # Reduce matrix size: only test postgres/mysql on latest Python + Django
          - python-version: "3.10"
            db-backend: "postgres"
          - python-version: "3.10"
            db-backend: "mysql"
          - python-version: "3.11"
            db-backend: "postgres"
          - python-version: "3.11"
            db-backend: "mysql"
          - django-version: "4.2"
            db-backend: "postgres"
          - django-version: "4.2"
            db-backend: "mysql"
          - django-version: "5.0"
            db-backend: "postgres"
          - django-version: "5.0"
            db-backend: "mysql"
          - django-version: "5.1"
            db-backend: "postgres"
          - django-version: "5.1"
            db-backend: "mysql"

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_djazzle
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test
          MYSQL_DATABASE: test_djazzle
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      # PostgreSQL connection details
      DB_HOST_POSTGRES: localhost
      DB_PORT_POSTGRES: 5432
      DB_NAME_POSTGRES: test_djazzle
      DB_USER_POSTGRES: postgres
      DB_PASSWORD_POSTGRES: postgres
      # MySQL connection details
      DB_HOST_MYSQL: localhost
      DB_PORT_MYSQL: 3306
      DB_NAME_MYSQL: test_djazzle
      DB_USER_MYSQL: root
      DB_PASSWORD_MYSQL: test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ matrix.django-version }}-${{ matrix.db-backend }}-${{ hashFiles('pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ matrix.django-version }}-
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv pip install --system -e ".[dev]"
        uv pip install --system "django~=${{ matrix.django-version }}.0"

    - name: Set database environment variables for PostgreSQL
      if: matrix.db-backend == 'postgres'
      run: |
        echo "DB_HOST=${{ env.DB_HOST_POSTGRES }}" >> $GITHUB_ENV
        echo "DB_PORT=${{ env.DB_PORT_POSTGRES }}" >> $GITHUB_ENV
        echo "DB_NAME=${{ env.DB_NAME_POSTGRES }}" >> $GITHUB_ENV
        echo "DB_USER=${{ env.DB_USER_POSTGRES }}" >> $GITHUB_ENV
        echo "DB_PASSWORD=${{ env.DB_PASSWORD_POSTGRES }}" >> $GITHUB_ENV

    - name: Set database environment variables for MySQL
      if: matrix.db-backend == 'mysql'
      run: |
        echo "DB_HOST=${{ env.DB_HOST_MYSQL }}" >> $GITHUB_ENV
        echo "DB_PORT=${{ env.DB_PORT_MYSQL }}" >> $GITHUB_ENV
        echo "DB_NAME=${{ env.DB_NAME_MYSQL }}" >> $GITHUB_ENV
        echo "DB_USER=${{ env.DB_USER_MYSQL }}" >> $GITHUB_ENV
        echo "DB_PASSWORD=${{ env.DB_PASSWORD_MYSQL }}" >> $GITHUB_ENV

    - name: Run tests
      run: |
        pytest --db ${{ matrix.db-backend }} --cov=src/djazzle --cov-report=xml --cov-report=term

    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.12' && matrix.django-version == '5.2' && matrix.db-backend == 'sqlite'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff mypy

    - name: Run ruff
      run: ruff check src/

    - name: Run mypy
      run: mypy src/ --ignore-missing-imports || true
